<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ¤– AI Interview Assistant</h1>
            <p>Practice your technical interview skills with AI-powered questions</p>
        </header>

        <main>
            <!-- Setup Section -->
            <section class="form-section" id="setupSection">
                <h2>Step 1: Interview Setup</h2>
                <form id="setupForm" class="form">
                    <div class="form-group">
                        <label for="resume">
                            <strong>Upload Resume (PDF)</strong>
                            <span class="hint">Optional: We will analyze your experience from the file</span>
                        </label>
                        <input type="file" id="resume" name="resume" accept=".pdf">
                        <div class="form-group">
                             <label for="context">
                                <strong>Additional Context (Optional)</strong>
                                <span class="hint">Paste any extra details about your experience here.</span>
                            </label>
                            <textarea id="context" name="context" rows="3" placeholder="I am applying for a Senior React role..."></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Start Interview</button>
                </form>
            </section>

            <!-- Question & Answer Section -->
            <section class="question-section" id="interviewSection" style="display: none;">
                <div class="progress-indicator">
                    Question <span id="currentQuestionNum">1</span> / 4
                </div>
                
                <h2><span id="questionTypeTitle">General Question</span></h2>
                <div class="question-box">
                    <p id="currentQuestionText" class="question-text"></p>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label for="answer"><strong>Your Answer:</strong></label>
                    <textarea id="answer" name="answer" rows="6" placeholder="Type your answer here..." required></textarea>
                </div>
                
                <button id="submitAnswerBtn" class="btn btn-primary">Submit Answer</button>
            </section>

            <!-- Feedback Section (Shown after each answer) -->
            <section class="response-section" id="feedbackSection" style="display: none;">
                <h2>Feedback</h2>
                <div class="response-box">
                    <p id="feedbackText"></p>
                </div>
                <button id="nextQuestionBtn" class="btn btn-secondary">Next Question</button>
            </section>

             <!-- Completion Section -->
             <section class="response-section" id="completionSection" style="display: none;">
                <h2>Interview Complete!</h2>
                <p>Thank you for completing the interview. Your results have been recorded.</p>
                <button class="btn btn-primary" onclick="location.reload()">Start New Interview</button>
            </section>

            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Thinking...</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </main>
    </div>

    <script>
        // State Management
        const state = {
            step: 0, // 0-1: General, 2-3: Resume
            generalQuestions: [],
            resumeText: "",
            userContext: "",
            currentQuestion: ""
        };

        // UI Helpers
        function showLoading() { document.getElementById('loadingIndicator').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingIndicator').style.display = 'none'; }
        function showSection(id) {
            ['setupSection', 'interviewSection', 'feedbackSection', 'completionSection'].forEach(s => {
                document.getElementById(s).style.display = (s === id) ? 'block' : 'none';
            });
        }
        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // 1. Start Interview - Upload Resume & Fetch General Questions
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            try {
                // Upload Resume & Context first
                const formData = new FormData();
                const fileInput = document.getElementById('resume');
                state.userContext = document.getElementById('context').value || "";

                if (fileInput.files[0]) {
                    formData.append('resume', fileInput.files[0]);
                    const resumeRes = await fetch('/process-resume', { method: 'POST', body: formData });
                    const resumeData = await resumeRes.json();
                    state.resumeText = resumeData.text || "";
                }

                // Get General Questions
                const qRes = await fetch('/general-questions');
                const qData = await qRes.json();
                state.generalQuestions = qData.questions;

                // Start Flow
                state.step = 0;
                displayQuestion();

            } catch (err) {
                console.error(err);
                showError("Failed to start interview.");
            } finally {
                hideLoading();
            }
        });

        // 2. Display Logic
        async function displayQuestion() {
            showSection('interviewSection');
            document.getElementById('answer').value = "";
            document.getElementById('currentQuestionNum').textContent = state.step + 1;

            if (state.step < 2) {
                // General Questions
                document.getElementById('questionTypeTitle').textContent = "General Coding Question";
                state.currentQuestion = state.generalQuestions[state.step].question;
                document.getElementById('currentQuestionText').textContent = state.currentQuestion;
            } else if (state.step < 4) {
                // Resume Questions
                document.getElementById('questionTypeTitle').textContent = "Resume-Based Question";
                showLoading();
                try {
                    // Generate dynamic question
                    const formData = new FormData();
                    formData.append('context', state.userContext);
                    formData.append('resume_text', state.resumeText);
                    
                    const res = await fetch('/generate-resume-question', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    state.currentQuestion = data.question;
                    document.getElementById('currentQuestionText').textContent = state.currentQuestion;
                } catch (err) {
                    showError("Failed to generate question.");
                } finally {
                    hideLoading();
                }
            } else {
                // Done
                showSection('completionSection');
            }
        }

        // 3. Submit Answer & Evaluate
        document.getElementById('submitAnswerBtn').addEventListener('click', async () => {
            const answer = document.getElementById('answer').value;
            if (!answer.trim()) { showError("Please enter an answer."); return; }

            showLoading();
            try {
                const res = await fetch('/evaluate-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: state.currentQuestion,
                        answer: answer
                    })
                });
                const data = await res.json();
                
                document.getElementById('feedbackText').textContent = data.feedback;
                showSection('feedbackSection');
            } catch (err) {
                showError("Evaluation failed.");
            } finally {
                hideLoading();
            }
        });

        // 4. Next Question
        document.getElementById('nextQuestionBtn').addEventListener('click', () => {
            state.step++;
            if (state.step >= 4) {
                showSection('completionSection');
            } else {
                displayQuestion();
            }
        });
    </script>
</body>
</html>